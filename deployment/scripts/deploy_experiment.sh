#!/bin/bash

QUERY=${1}                      #{1, 2, 3, 5, 8, 11}
MODE=${2}                       #{reactive, non-reactive}
INITIAL_PARALLELISM=${3}
AVAILABLE_TASKMANAGERS=${4}
AUTOSCALER=${5}
AUTOSCALER_CONFIGURATION_0=${6}
AUTOSCALER_CONFIGURATION_1=${7}
AUTOSCALER_CONFIGURATION_2=${8}
LOAD_PATTERN=${9}               # {cosinus, cosinus-spikes, random}
EXPERIMENT_DURATION=${10}
WORKLOAD_CONFIGURATION_0=${11} # workload configuration 1
WORKLOAD_CONFIGURATION_1=${12} # workload configuration 2
WORKLOAD_CONFIGURATION_2=${13} # workload configuration 3
WORKLOAD_CONFIGURATION_3=${14} # workload configuration 4
NAMESPACE=${15}

AUTOSCALER_DEPLOYMENT_COOLDOWN="2m"

echo "Deploying experiment with:
  Query=${QUERY}
  MODE=${MODE}
  INITIAL_PARALLELISM=${INITIAL_PARALLELISM}
  AVAILABLE_TASKMANAGERS=${AVAILABLE_TASKMANAGERS}
  AUTOSCALER=${AUTOSCALER}
  AUTOSCALER_CONFIGURATION_0=${AUTOSCALER_CONFIGURATION_0}
  AUTOSCALER_CONFIGURATION_1=${AUTOSCALER_CONFIGURATION_1}
  AUTOSCALER_CONFIGURATION_2=${AUTOSCALER_CONFIGURATION_2}
  LOAD_PATTERN=${LOAD_PATTERN}
  EXPERIMENT_DURATION=${EXPERIMENT_DURATION}
  WORKLOAD_CONFIGURATION_0=${WORKLOAD_CONFIGURATION_0}
  WORKLOAD_CONFIGURATION_1=${WORKLOAD_CONFIGURATION_1}
  WORKLOAD_CONFIGURATION_2=${WORKLOAD_CONFIGURATION_2}
  WORKLOAD_CONFIGURATION_3=${WORKLOAD_CONFIGURATION_3}
  NAMESPACE=${NAMESPACE}
  "

source ./deploy_nfs.sh "$NAMESPACE"

source ./deploy_queries.sh \
  "${QUERY}" "${MODE}" \
  "${INITIAL_PARALLELISM}" \
  "${AVAILABLE_TASKMANAGERS}" \
  "${LOAD_PATTERN}" \
  "${EXPERIMENT_DURATION}" \
  "${WORKLOAD_CONFIGURATION_0}" \
  "${WORKLOAD_CONFIGURATION_1}" \
  "${WORKLOAD_CONFIGURATION_2}" \
  "${WORKLOAD_CONFIGURATION_3}"

echo "Sleeping for $AUTOSCALER_DEPLOYMENT_COOLDOWN before deploying autoscaler."
sleep "$AUTOSCALER_DEPLOYMENT_COOLDOWN"
source ./deploy_autoscaler.sh \
  "${QUERY}" \
  "${MODE}" \
  "${AVAILABLE_TASKMANAGERS}" \
  "${NAMESPACE}" \
  "${AUTOSCALER}" \
  "${AUTOSCALER_CONFIGURATION_0}" \
  "${AUTOSCALER_CONFIGURATION_1}" \
  "${AUTOSCALER_CONFIGURATION_2}"

echo "Finished deployment"
