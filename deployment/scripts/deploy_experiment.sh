#!/bin/bash

QUERY=${1}                      #{1, 2, 3, 5, 8, 11}
MODE=${2}                       #{reactive, non-reactive}
INITIAL_PARALLELISM=${3}
AVAILABLE_TASKMANAGERS=${4}
AUTOSCALER=${5}
AUTOSCALER_CONFIGURATION=${6}
LOAD_PATTERN=${7}               # {cosinus, cosinus-spikes, random}
INPUT_RATE_MEAN=${8}            # Mean of cosinus, start-point of random
INPUT_RATE_MAX_DIVERGENCE=${9}  # Input range of: cosine: (m - d, m + d), random step (-max_divergence, max_divergence)
NAMESPACE=${10}

AUTOSCALER_DEPLOYMENT_COOLDOWN="2m"
echo "Deploying experiment with: Query=$QUERY MODE=$MODE INITIAL_PARALLELISM=$INITIAL_PARALLELISM AVAILABLE_TASKMANAGERS=$AVAILABLE_TASKMANAGERS AUTOSCALER=$AUTOSCALER AUTOSCALER_CONFIGURATION=$AUTOSCALER_CONFIGURATION LOAD_PATTERN=$LOAD_PATTERN INPUT_RATE_MEAN=$INPUT_RATE_MEAN INPUT_RATE_MAX_DIVERGENCE=$INPUT_RATE_MAX_DIVERGENCE INPUT_RATE_MAX_NOISE=$INPUT_RATE_MAX_NOISE NAMESPACE=$NAMESPACE"
source ./deploy_nfs.sh "$NAMESPACE"
source ./deploy_queries.sh "$QUERY" "$MODE" "$INITIAL_PARALLELISM" "$AVAILABLE_TASKMANAGERS" "$LOAD_PATTERN" "$INPUT_RATE_MEAN" "$INPUT_RATE_MAX_DIVERGENCE"

echo "Sleeping for $AUTOSCALER_DEPLOYMENT_COOLDOWN before deploying autoscaler."
sleep "$AUTOSCALER_DEPLOYMENT_COOLDOWN"

source ./deploy_autoscaler.sh "$AUTOSCALER" "$AUTOSCALER_CONFIGURATION" "$QUERY" "$MODE" "$AVAILABLE_TASKMANAGERS" "$NAMESPACE"
echo "Finished deployment"
